# Rate-Distortion Curve Test Code


# Abstract

This document presents a tool to test video codecs, calculating RD-curves for a series of parameters. It can be easily extended to test any other codecs.


# 1. Introduction
We want to characterize the rate-distortion curve for a set of video encoders. The goal is understanding the influence of the bitrate on distortion.


# 2. Operation

## 2.1. Data Gathering
The tool that runs the experiments is called `rdtest.sh`. In order to run it, first you need to find a reference file that will be used to test the encoder.

Run a simple encoder test:

```
$ ./rdtest.sh /tmp/input.mp4 /tmp/results.txt --tmpdir /tmp/rdtest_tmp --resolutions "216x120" --bitrates "35" --rcmodes "cbr" -d
```

Notes:

* test will run all the defined codecs, for a single resolution (216x120), a single bitrate (35 kbps), and a single rate control model (CBR),
* defined codecs so far are vp8, vanilla x264, and lcevc-x264,
* "-d" forces debug mode (useful to test the script).
* the test requires a VMAF distribution, either a separate one (slower), or an ffmpeg binary that supports VMAF (faster).


Once you are happy with the results, run the full experiment.

```
$ ./rdtest.sh /tmp/input.mp4 /tmp/results.txt --tmpdir /tmp/rdtest_tmp
```

The results are dumped to a text file, which contains a CSV collection of encoding parameters and video quality results (PSNR, SSIM, and VMAF).

```
$ cat /tmp/results.txt
# in_filename,codec,resolution,rcmode,bitrate,actual_bitrate,psnr,ssim,vmaf
input.mp4,lcevc-x264,1280x720,cbr,2500,2973,36.518814,0.971159,94.448697
input.mp4,lcevc-x264,1280x720,cbr,1000,1265,35.216348,0.962273,91.528012
input.mp4,lcevc-x264,1280x720,cbr,280,357,33.397083,0.941782,80.188933
input.mp4,lcevc-x264,1280x720,cbr,560,711,34.476834,0.954649,87.839567
input.mp4,lcevc-x264,1280x720,cbr,140,174,31.808458,0.922022,66.581716
...
input.mp4,x264,216x120,cbr,70,92,27.633973,0.856106,14.204752
input.mp4,x264,216x120,cbr,35,50,27.219975,0.845131,7.861652
```

## 2.2. Data Plotting
The tool that plots the results of the previous experiments is called `rdplot.py`. In order to run it, you need to `results.txt` file generated by the previous tool.

```
./rdplot.py results.txt
```

![](results.txt.vmaf.png)
Figure 1 shows the VMAF results of the x264 vs. lcevc-x264 encoders.

![](results.txt.overshoot.png)
Figure 2 shows the bitrate accuracy (overshoot) results of the x264 vs. lcevc-x264 encoders.


# 3. References



# Appendix: Install VMAF Support

## A.1. Install Separate VMAF Support

First, check whether your `ffmpeg` binary already has VMAF support. Run the following script:

```
ffmpeg_vmaf=$(ffmpeg -filters|&grep libvmaf |grep "Calculate the VMAF")
if [[ "${ffmpeg_vmaf}" == *"Calculate the VMAF"* ]]; then
  echo "ffmpeg supports VMAF"
else
  echo "ffmpeg does not support VMAF"
fi
```


If the script produces "ffmpeg supports VMAF", you are done.

Otherwise, install the VMAF repo:

```
$ cd ~/proj/
$ git clone https://github.com/Netflix/vmaf
$ cd vmaf
-- make sure you have numpy 1.5
$ sudo pip install numpy==1.15
$ make
$ sudo make install
```


Notes:

* replace the `includedir` variable in `/usr/local/lib64/pkgconfig/libvmaf.pc` with `includedir=${prefix}/include/libvmaf`, and then build `ffmpeg` from source.
* if you decide to install it in a different place, use the `--vmaf-dir` CLI option to let `rdtest.sh` know about the location


Now build ffmpeg from the source with support for the library.

```
$ cd ~/proj/
$ git clone git://source.ffmpeg.org/ffmpeg.git ffmpeg
$ cd ffmpeg
$ PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig ./configure --enable-libvmaf --enable-version3
...
$ make
$ sudo make install
```

